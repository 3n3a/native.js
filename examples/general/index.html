<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Native.js Demo</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 2rem; max-width: 900px; margin: 0 auto; }
        h1, h2, h3 { margin-top: 2rem; }
        .counter { display: flex; gap: 1rem; align-items: center; margin: 1rem 0; }
        button { padding: 0.5rem 1rem; cursor: pointer; }
        .state-display { background: #f0f0f0; padding: 1rem; border-radius: 4px; margin: 1rem 0; font-size: 0.9rem; }
        .user-card { border: 1px solid #ddd; padding: 1rem; margin: 0.5rem 0; border-radius: 4px; }
        .user-card h4 { margin: 0 0 0.5rem 0; }
        .loading { color: #666; font-style: italic; }
        .error { color: #c00; }
        form { display: flex; flex-direction: column; gap: 0.5rem; max-width: 300px; }
        input, textarea { padding: 0.5rem; }
        .submit-result { margin-top: 1rem; padding: 1rem; background: #e8f5e9; border-radius: 4px; }
        .submit-result.error { background: #ffebee; }
        nav { margin: 1rem 0; display: flex; gap: 1rem; }
        nav a { color: #0066cc; }
        hr { margin: 2rem 0; }
    </style>
</head>
<body>
    <main id="app"></main>

    <!-- Home Page Template -->
    <template id="tpl-home">
        <h1>Native.js Demo</h1>
        <nav>
            <a n-href="/data-demo">Data Fetching Demo</a>
            <a n-href="/state-demo">State Demo</a>
        </nav>
        <n-footer></n-footer>
    </template>

    <!-- Data Demo Page Template -->
    <template id="tpl-data-demo">
        <h1>Data Fetching & Submit Demo</h1>
        <nav>
            <a n-href="/">Home</a>
            <a n-href="/state-demo">State Demo</a>
        </nav>
        
        <h2>Auto-Fetch (n-fetch attribute)</h2>
        <p>This component fetches data automatically when mounted:</p>
        <n-user-list n-fetch="../api/users.json" n-fetch-key="users"></n-user-list>
        
        <h2>Manual Fetch (using injected DataService)</h2>
        <n-posts-list></n-posts-list>
        
        <h2>Submit Data (using injected DataService)</h2>
        <n-contact-form></n-contact-form>
        
        <n-footer></n-footer>
    </template>

    <!-- State Demo Page Template -->
    <template id="tpl-state-demo">
        <h1>State Management Demo</h1>
        <nav>
            <a n-href="/">Home</a>
            <a n-href="/data-demo">Data Fetching Demo</a>
        </nav>
        
        <h3>Counter with Attribute State (n-state)</h3>
        <n-counter n-state='{"count": 0}'></n-counter>

        <h3>Counter with Session Storage (n-state-key)</h3>
        <p><em>Persists across page refreshes within session</em></p>
        <n-counter n-state-key="session-counter" n-state-storage="session"></n-counter>

        <h3>Counter with Local Storage</h3>
        <p><em>Persists even after browser restart</em></p>
        <n-counter n-state-key="local-counter" n-state-storage="local"></n-counter>
        
        <n-footer></n-footer>
    </template>

    <!-- User List Template (auto-fetch example) -->
    <template id="tpl-user-list">
        <div class="user-list">
            <div class="loading-indicator"></div>
            <div class="error-message"></div>
            <div class="users-container"></div>
        </div>
    </template>

    <!-- Posts List Template (manual fetch example) -->
    <template id="tpl-posts-list">
        <div class="posts-list">
            <button class="fetch-btn">Fetch Posts</button>
            <div class="loading-indicator"></div>
            <div class="posts-container"></div>
        </div>
    </template>

    <!-- Contact Form Template (submit example) -->
    <template id="tpl-contact-form">
        <div class="contact-form">
            <form>
                <input type="text" name="name" placeholder="Your name" required>
                <input type="email" name="email" placeholder="Your email" required>
                <textarea name="message" placeholder="Your message" rows="3" required></textarea>
                <button type="submit">Submit</button>
            </form>
            <div class="submit-result-container"></div>
        </div>
    </template>

    <!-- Counter Template -->
    <template id="tpl-counter">
        <div class="counter">
            <button class="decrement">-</button>
            <span class="count">0</span>
            <button class="increment">+</button>
        </div>
        <div class="state-display">
            <strong>Mode:</strong> <span class="mode"></span> | 
            <strong>State:</strong> <code class="state-json"></code>
        </div>
    </template>

    <!-- Footer Template -->
    <template id="tpl-footer">
        <footer style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ccc; color: #666;">
            <p>Native.js Framework Demo</p>
        </footer>
    </template>
    
    <script type="module">
        import { 
            createNativeJs, 
            NativeJsComponent, 
            NativeJsService,
            createNativeJsComponentRegistry 
        } from "../lib/index.js";
        
        const container = document.querySelector('#app');

        // ============================================
        // DATA SERVICE - Injectable service for API calls
        // ============================================
        class DataService extends NativeJsService {
            constructor(container) {
                super(container);
                this.baseUrl = '../api';
            }
            
            async getUsers() {
                const response = await fetch(`${this.baseUrl}/users.json`);
                return response.json();
            }
            
            async getPosts() {
                const response = await fetch(`${this.baseUrl}/posts.json`);
                return response.json();
            }
            
            async submitContact(data) {
                // Simulated submit - in real app would POST to server
                await new Promise(r => setTimeout(r, 500)); // Simulate network delay
                const response = await fetch(`${this.baseUrl}/submit-response.json`);
                return response.json();
            }
        }

        // ============================================
        // LOGGER SERVICE - Example of another injectable service
        // ============================================
        class LoggerService extends NativeJsService {
            constructor(container) {
                super(container);
                this.prefix = '[Native.js]';
            }
            
            log(message, data) {
                console.log(`${this.prefix} ${message}`, data || '');
            }
            
            error(message, error) {
                console.error(`${this.prefix} ${message}`, error || '');
            }
        }

        // ============================================
        // User List Component (Auto-fetch example)
        // ============================================
        class UserListElement extends NativeJsComponent {
            static tagName = 'n-user-list';
            static templateId = 'tpl-user-list';
            static dependencies = ['logger'];

            onInit() {
                this.logger.log('UserList component initialized');
                this.updateDisplay();
            }

            onDataFetched(stateKey, data, error) {
                this.logger.log('Users fetched via n-fetch attribute', { stateKey, data, error });
                this.updateDisplay();
            }

            updateDisplay() {
                const loadingEl = this.getChild('.loading-indicator');
                const errorEl = this.getChild('.error-message');
                const containerEl = this.getChild('.users-container');

                const isLoading = this.state.get('usersLoading');
                const error = this.state.get('usersError');
                const data = this.state.get('users');

                if (loadingEl) {
                    loadingEl.innerHTML = isLoading ? '<p class="loading">Loading users...</p>' : '';
                }

                if (errorEl) {
                    errorEl.innerHTML = error ? `<p class="error">Error: ${error}</p>` : '';
                }

                if (containerEl && data?.users) {
                    containerEl.innerHTML = data.users.map(user => `
                        <div class="user-card">
                            <h4>${user.name}</h4>
                            <p>${user.email} - ${user.role}</p>
                        </div>
                    `).join('');
                }
            }
        }

        // ============================================
        // Posts List Component (Manual fetch using injected service)
        // ============================================
        class PostsListElement extends NativeJsComponent {
            static tagName = 'n-posts-list';
            static templateId = 'tpl-posts-list';
            static dependencies = ['dataService', 'logger'];

            onInit() {
                this.logger.log('PostsList component initialized');
                const fetchBtn = this.getChild('.fetch-btn');
                fetchBtn?.addEventListener('click', () => this.fetchPosts());
            }

            async fetchPosts() {
                const loadingEl = this.getChild('.loading-indicator');
                const containerEl = this.getChild('.posts-container');

                if (loadingEl) loadingEl.innerHTML = '<p class="loading">Loading posts...</p>';
                if (containerEl) containerEl.innerHTML = '';

                try {
                    // Use injected data service instead of this.data
                    const data = await this.dataService.getPosts();
                    this.logger.log('Posts fetched via DataService', data);
                    
                    if (loadingEl) loadingEl.innerHTML = '';

                    if (containerEl) {
                        const posts = data?.posts || [];
                        containerEl.innerHTML = posts.map(post => `
                            <div class="user-card">
                                <h4>${post.title}</h4>
                                <p>${post.content}</p>
                                <small>By ${post.author} on ${post.date}</small>
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    this.logger.error('Failed to fetch posts', error);
                    if (loadingEl) loadingEl.innerHTML = '<p class="error">Failed to load posts</p>';
                }
            }
        }

        // ============================================
        // Contact Form Component (Submit using injected service)
        // ============================================
        class ContactFormElement extends NativeJsComponent {
            static tagName = 'n-contact-form';
            static templateId = 'tpl-contact-form';
            static dependencies = ['dataService', 'logger'];

            onInit() {
                this.logger.log('ContactForm component initialized');
                const form = this.getChild('form');
                form?.addEventListener('submit', (e) => this.handleSubmit(e));
            }

            async handleSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                const resultContainer = this.getChild('.submit-result-container');
                if (resultContainer) {
                    resultContainer.innerHTML = '<p class="loading">Submitting...</p>';
                }

                try {
                    // Use injected data service
                    const response = await this.dataService.submitContact(data);
                    this.logger.log('Form submitted via DataService', response);

                    if (resultContainer) {
                        resultContainer.innerHTML = `
                            <div class="submit-result">
                                <strong>Success!</strong><br>
                                ${response.message}<br>
                                <small>ID: ${response.id}</small>
                            </div>
                        `;
                        form.reset();
                    }
                } catch (error) {
                    this.logger.error('Form submission failed', error);
                    if (resultContainer) {
                        resultContainer.innerHTML = `
                            <div class="submit-result error">
                                <strong>Error:</strong> ${error.message}
                            </div>
                        `;
                    }
                }
            }
        }

        // ============================================
        // Counter Component (State example)
        // ============================================
        class CounterElement extends NativeJsComponent {
            static tagName = 'n-counter';
            static templateId = 'tpl-counter';
            static dependencies = ['logger'];

            onInit() {
                if (!this.state.has('count')) {
                    this.state.set('count', 0);
                }
                this.logger.log('Counter initialized', { mode: this.state.getMode() });
                this.updateDisplay();
                this.setupEventListeners();
            }

            setupEventListeners() {
                this.getChild('.increment')?.addEventListener('click', () => {
                    this.state.set('count', (this.state.get('count') ?? 0) + 1);
                    this.updateDisplay();
                });
                this.getChild('.decrement')?.addEventListener('click', () => {
                    this.state.set('count', (this.state.get('count') ?? 0) - 1);
                    this.updateDisplay();
                });
            }

            updateDisplay() {
                const countEl = this.getChild('.count');
                const modeEl = this.getChild('.mode');
                const stateJsonEl = this.getChild('.state-json');

                if (countEl) countEl.textContent = String(this.state.get('count') ?? 0);
                if (modeEl) {
                    const mode = this.state.getMode();
                    const key = this.state.getStorageKey();
                    modeEl.textContent = mode === 'storage' ? `storage (${key})` : 'attribute';
                }
                if (stateJsonEl) stateJsonEl.textContent = JSON.stringify(this.state.getAll());
            }
        }

        // ============================================
        // Page Components
        // ============================================
        class HomeElement extends NativeJsComponent {
            static tagName = 'n-home';
            static templateId = 'tpl-home';
        }

        class DataDemoElement extends NativeJsComponent {
            static tagName = 'n-data-demo';
            static templateId = 'tpl-data-demo';
        }

        class StateDemoElement extends NativeJsComponent {
            static tagName = 'n-state-demo';
            static templateId = 'tpl-state-demo';
        }

        class FooterElement extends NativeJsComponent {
            static tagName = 'n-footer';
            static templateId = 'tpl-footer';
        }

        // ============================================
        // Register & Run with DI
        // ============================================
        const registry = createNativeJsComponentRegistry();
        registry.registerComponentClass(FooterElement);
        registry.registerComponentClass(CounterElement);
        registry.registerComponentClass(UserListElement);
        registry.registerComponentClass(PostsListElement);
        registry.registerComponentClass(ContactFormElement);

        const routes = [
            { pathname: '/', element: HomeElement },
            { pathname: '/data-demo', element: DataDemoElement },
            { pathname: '/state-demo', element: StateDemoElement }
        ];

        // Create app
        const nativeJs = createNativeJs(container, routes);
        
        // Register services with DI container
        nativeJs.singleton('logger', LoggerService);
        nativeJs.singleton('dataService', DataService);
        
        // Start the app
        nativeJs.run();
        
        // Log that DI is active
        nativeJs.resolve('logger').log('App started with DI', {
            services: nativeJs.container.getTokens()
        });

        window.nativeJs = nativeJs;
    </script>
</body>
</html>
