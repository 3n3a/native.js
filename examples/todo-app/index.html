<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #222;
            line-height: 1.5;
        }
        
        #app {
            max-width: 480px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        /* Forms */
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            background: white;
        }
        
        input:focus {
            outline: none;
            border-color: #333;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .btn {
            background: #222;
            color: white;
        }
        
        .btn:hover { background: #444; }
        .btn:disabled { background: #999; cursor: not-allowed; }
        
        .btn-ghost {
            background: transparent;
            color: #666;
            border: 1px solid #ddd;
        }
        
        .btn-ghost:hover { background: #f0f0f0; }
        
        .btn-delete {
            background: transparent;
            color: #999;
            padding: 8px;
        }
        
        .btn-delete:hover { color: #c00; }
        
        .btn-danger {
            background: #c00;
            color: white;
        }
        
        .btn-danger:hover { background: #a00; }
        
        /* Card */
        .card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .card-body {
            padding: 24px;
        }
        
        /* Auth */
        .auth-title {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 24px;
        }
        
        .auth-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 24px;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: none;
            border: none;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        
        .auth-tab.active {
            color: #222;
            border-bottom-color: #222;
        }
        
        .auth-form {
            display: none;
            flex-direction: column;
            gap: 16px;
        }
        
        .auth-form.active { display: flex; }
        
        .error-msg {
            background: #fee;
            color: #c00;
            padding: 12px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* Form message styling for n-submit-form */
        .n-form-message {
            padding: 12px;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 12px;
        }
        
        .n-form-error {
            background: #fee;
            color: #c00;
        }
        
        .n-form-success {
            background: #efe;
            color: #060;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #666;
        }
        
        /* Add form */
        .add-form,
        .add-form form {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .add-form form { margin-bottom: 0; }
        .add-form input { flex: 1; }
        
        /* List items */
        .list-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: #fafafa; }
        
        .list-item-name {
            flex: 1;
            font-size: 15px;
        }
        
        /* Todo items */
        .todo-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            gap: 12px;
        }
        
        .todo-item:last-child { border-bottom: none; }
        
        .todo-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .todo-text {
            flex: 1;
            font-size: 15px;
        }
        
        .todo-text.completed {
            text-decoration: line-through;
            color: #999;
        }
        
        /* List header */
        .list-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .back-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            color: #666;
        }
        
        .back-btn:hover { color: #222; }
        
        .list-title-input {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            border: none;
            padding: 4px 0;
            background: transparent;
        }
        
        .list-title-input:focus {
            outline: none;
            border-bottom: 1px solid #ddd;
        }
        
        /* Empty state */
        .empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 14px;
        }
        
        /* n-list empty state */
        .n-list-empty {
            text-align: center;
            padding: 40px 20px !important;
            color: #999;
            font-size: 14px;
        }
        
        /* n-list container */
        .n-list-container {
            min-height: 0;
        }
        
        /* Modal overrides for n-modal */
        n-modal {
            --n-modal-padding: 20px;
            --n-modal-max-width: 360px;
        }
    </style>
</head>
<body>
    <main id="app"></main>

    <!-- Auth Page -->
    <template id="tpl-auth">
        <div class="card">
            <div class="card-body">
                <h1 class="auth-title">Todo</h1>
                
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">Sign in</button>
                    <button class="auth-tab" data-tab="register">Create account</button>
                </div>
                
                <div class="error-msg" style="display: none;"></div>
                
                <n-submit-form class="auth-form active" id="login-form" n-action="/api/login" n-credentials="include">
                    <input type="text" name="username" placeholder="Username" required>
                    <input type="password" name="password" placeholder="Password" required>
                    <button type="submit" class="btn">Sign in</button>
                </n-submit-form>
                
                <n-submit-form class="auth-form" id="register-form" n-action="/api/register" n-credentials="include">
                    <input type="text" name="username" placeholder="Username" required minlength="3">
                    <input type="password" name="password" placeholder="Password" required minlength="4">
                    <input type="password" name="password_confirm" placeholder="Confirm password" required>
                    <button type="submit" class="btn">Create account</button>
                </n-submit-form>
            </div>
        </div>
    </template>

    <!-- Lists Page -->
    <template id="tpl-lists">
        <div class="header">
            <h1>My Lists</h1>
            <div class="header-right">
                <span class="username"></span>
                <button class="btn-ghost logout-btn">Sign out</button>
            </div>
        </div>
        
        <n-submit-form class="add-form" id="add-list-form" n-action="/api/lists" n-credentials="include" n-reset="true">
            <input type="text" name="name" placeholder="New list..." required>
            <button type="submit" class="btn">Add</button>
        </n-submit-form>
        
        <div class="card">
            <n-list id="lists-list" n-empty-text="No lists yet">
                <template n-item>
                    <div class="list-item" data-id="{{id}}">
                        <span class="list-item-name">{{name}}</span>
                        <button class="btn-delete delete-btn" data-id="{{id}}">×</button>
                    </div>
                </template>
            </n-list>
        </div>
        
        <n-modal id="delete-list-modal" n-title="Delete this list?" n-closable="true">
            <p>All todos in this list will be deleted.</p>
            <div n-slot="footer">
                <button class="btn-ghost" n-modal-cancel>Cancel</button>
                <button class="btn-danger" n-modal-confirm>Delete</button>
            </div>
        </n-modal>
    </template>

    <!-- Todos Page -->
    <template id="tpl-todos">
        <div class="header">
            <h1>Todo</h1>
            <div class="header-right">
                <span class="username"></span>
                <button class="btn-ghost logout-btn">Sign out</button>
            </div>
        </div>
        
        <div class="list-header">
            <button class="back-btn">←</button>
            <input type="text" class="list-title-input" placeholder="List name">
            <button class="btn-delete delete-list-btn">Delete</button>
        </div>
        
        <n-submit-form class="add-form" id="add-todo-form" n-action="" n-credentials="include" n-reset="true">
            <input type="text" name="text" placeholder="Add todo..." required>
            <button type="submit" class="btn">Add</button>
        </n-submit-form>
        
        <div class="card">
            <n-list id="todos-list" n-empty-text="No todos yet">
                <template n-item>
                    <div class="todo-item" data-id="{{id}}" data-completed="{{completed}}">
                        <input type="checkbox" class="todo-checkbox" data-id="{{id}}">
                        <span class="todo-text">{{text}}</span>
                        <button class="btn-delete delete-todo-btn" data-id="{{id}}">×</button>
                    </div>
                </template>
            </n-list>
        </div>
        
        <n-modal id="delete-list-modal" n-title="Delete this list?" n-closable="true">
            <p>All todos in this list will be deleted.</p>
            <div n-slot="footer">
                <button class="btn-ghost" n-modal-cancel>Cancel</button>
                <button class="btn-danger" n-modal-confirm>Delete</button>
            </div>
        </n-modal>
        
        <n-modal id="delete-todo-modal" n-title="Delete this todo?" n-closable="true">
            <p>This todo item will be permanently deleted.</p>
            <div n-slot="footer">
                <button class="btn-ghost" n-modal-cancel>Cancel</button>
                <button class="btn-danger" n-modal-confirm>Delete</button>
            </div>
        </n-modal>
    </template>

    <script type="module">
        import { 
            createNativeJs, 
            NativeJsComponent,
            NativeJsService,
            registerDefaultComponents,
            navigateTo
        } from "../lib/index.js";
        
        // Register default components (n-submit-form, n-list, n-modal, etc.)
        registerDefaultComponents();
        
        // ============================================
        // AUTH SERVICE - Manages authentication state
        // ============================================
        class AuthService extends NativeJsService {
            constructor(container) {
                super(container);
                this._user = null;
                this._checked = false;
                this._listeners = new Set();
            }
            
            get isAuthenticated() {
                return this._user !== null;
            }
            
            get user() {
                return this._user;
            }
            
            get isChecked() {
                return this._checked;
            }
            
            /**
             * Check authentication status with server
             */
            async checkAuth() {
                try {
                    const response = await fetch('/api/me', { credentials: 'include' });
                    if (response.ok) {
                        const data = await response.json();
                        this._user = data.user;
                    } else {
                        this._user = null;
                    }
                } catch {
                    this._user = null;
                }
                this._checked = true;
                this._notifyListeners();
                return this._user;
            }
            
            /**
             * Set user after successful login/register
             */
            setUser(user) {
                this._user = user;
                this._checked = true;
                this._notifyListeners();
            }
            
            /**
             * Clear user on logout
             */
            clearUser() {
                this._user = null;
                this._notifyListeners();
            }
            
            /**
             * Logout - calls server and clears state
             */
            async logout() {
                await fetch('/api/logout', { 
                    method: 'POST', 
                    credentials: 'include' 
                });
                this.clearUser();
            }
            
            /**
             * Subscribe to auth state changes
             */
            subscribe(callback) {
                this._listeners.add(callback);
                return () => this._listeners.delete(callback);
            }
            
            _notifyListeners() {
                this._listeners.forEach(cb => cb(this.isAuthenticated, this._user));
            }
        }
        
        // ============================================
        // API SERVICE - HTTP requests with auth
        // ============================================
        class ApiService extends NativeJsService {
            constructor(container) {
                super(container);
                this.auth = this.resolve('auth');
            }
            
            async fetch(url) {
                const response = await fetch(url, { credentials: 'include' });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            }
            
            async post(url, data) {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                return { ok: response.ok, data: await response.json() };
            }
            
            async put(url, data) {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                return { ok: response.ok, data: await response.json() };
            }
            
            async delete(url) {
                const response = await fetch(url, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                return { ok: response.ok };
            }
            
            // === Lists API ===
            async getLists() {
                return this.fetch('/api/lists');
            }
            
            async deleteList(id) {
                return this.delete(`/api/lists/${id}`);
            }
            
            async updateList(id, data) {
                return this.put(`/api/lists/${id}`, data);
            }
            
            // === Todos API ===
            async getTodos(listId) {
                return this.fetch(`/api/lists/${listId}/todos`);
            }
            
            async toggleTodo(id) {
                return this.put(`/api/todos/${id}`, { toggle: true });
            }
            
            async deleteTodo(id) {
                return this.delete(`/api/todos/${id}`);
            }
        }
        
        // ============================================
        // AUTH PAGE COMPONENT
        // ============================================
        class AuthPage extends NativeJsComponent {
            static tagName = 'n-auth-page';
            static templateId = 'tpl-auth';
            static dependencies = ['auth'];
            
            onInit() {
                // Redirect if already authenticated
                if (this.auth.isAuthenticated) {
                    navigateTo('/lists');
                    return;
                }
                
                const tabs = this.getChildren('.auth-tab');
                const loginForm = this.getChild('#login-form');
                const registerForm = this.getChild('#register-form');
                
                // Tab switching
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        loginForm.classList.toggle('active', tab.dataset.tab === 'login');
                        registerForm.classList.toggle('active', tab.dataset.tab === 'register');
                        this.hideError();
                    });
                });
                
                // Handle login success
                loginForm.addEventListener('n-submit-success', (e) => {
                    this.auth.setUser(e.detail.data.user);
                    navigateTo('/lists');
                });
                
                loginForm.addEventListener('n-submit-error', (e) => {
                    this.showError(e.detail.error || 'Login failed');
                });
                
                // Handle register with password confirmation
                registerForm.addEventListener('n-submit-start', (e) => {
                    const form = registerForm.querySelector('form');
                    if (form.password.value !== form.password_confirm.value) {
                        e.preventDefault();
                        this.showError('Passwords do not match');
                    }
                });
                
                registerForm.addEventListener('n-submit-success', (e) => {
                    this.auth.setUser(e.detail.data.user);
                    navigateTo('/lists');
                });
                
                registerForm.addEventListener('n-submit-error', (e) => {
                    this.showError(e.detail.error || 'Registration failed');
                });
            }
            
            showError(msg) {
                const el = this.getChild('.error-msg');
                el.textContent = msg;
                el.style.display = 'block';
            }
            
            hideError() {
                this.getChild('.error-msg').style.display = 'none';
            }
        }
        
        // ============================================
        // LISTS PAGE COMPONENT
        // ============================================
        class ListsPage extends NativeJsComponent {
            static tagName = 'n-lists-page';
            static templateId = 'tpl-lists';
            static dependencies = ['auth', 'api'];
            
            deleteListId = null;
            
            async onInit() {
                // Check authentication via injected auth service
                if (!this.auth.isAuthenticated) {
                    await this.auth.checkAuth();
                    if (!this.auth.isAuthenticated) {
                        navigateTo('/');
                        return;
                    }
                }
                
                this.listEl = this.getChild('#lists-list');
                this.modal = this.getChild('#delete-list-modal');
                
                // Display username from auth service
                this.getChild('.username').textContent = this.auth.user.username;
                
                // Logout button uses auth service
                this.getChild('.logout-btn').addEventListener('click', async () => {
                    await this.auth.logout();
                    navigateTo('/');
                });
                
                // Handle add list form
                this.getChild('#add-list-form').addEventListener('n-submit-success', () => {
                    this.loadLists();
                });
                
                // Handle list click
                this.listEl.addEventListener('n-item-click', (e) => {
                    const target = e.detail.originalEvent.target;
                    if (!target.classList.contains('delete-btn')) {
                        navigateTo(`/list/${e.detail.item.id}`);
                    }
                });
                
                // Handle delete button
                this.listEl.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-btn')) {
                        e.stopPropagation();
                        this.deleteListId = e.target.dataset.id;
                        this.modal.open();
                    }
                });
                
                // Handle modal confirm - uses api service
                this.modal.addEventListener('n-modal-confirm', async () => {
                    if (this.deleteListId) {
                        await this.api.deleteList(this.deleteListId);
                        this.modal.close();
                        this.deleteListId = null;
                        this.loadLists();
                    }
                });
                
                this.loadLists();
            }
            
            async loadLists() {
                try {
                    const data = await this.api.getLists();
                    this.listEl.setItems(data.lists || []);
                } catch {
                    this.listEl.setItems([]);
                }
            }
        }
        
        // ============================================
        // TODOS PAGE COMPONENT
        // ============================================
        class TodosPage extends NativeJsComponent {
            static tagName = 'n-todos-page';
            static templateId = 'tpl-todos';
            static dependencies = ['auth', 'api'];
            
            listId = null;
            deleteTodoId = null;
            
            async onInit(urlPatternResult) {
                // Check authentication via injected auth service
                if (!this.auth.isAuthenticated) {
                    await this.auth.checkAuth();
                    if (!this.auth.isAuthenticated) {
                        navigateTo('/');
                        return;
                    }
                }
                
                this.listId = urlPatternResult?.pathname?.groups?.id;
                if (!this.listId) {
                    navigateTo('/lists');
                    return;
                }
                
                this.todosEl = this.getChild('#todos-list');
                this.deleteListModal = this.getChild('#delete-list-modal');
                this.deleteTodoModal = this.getChild('#delete-todo-modal');
                
                // Set dynamic form action
                const addTodoForm = this.getChild('#add-todo-form');
                addTodoForm.setAttribute('n-action', `/api/lists/${this.listId}/todos`);
                
                // Display username from auth service
                this.getChild('.username').textContent = this.auth.user.username;
                
                // Logout button uses auth service
                this.getChild('.logout-btn').addEventListener('click', async () => {
                    await this.auth.logout();
                    navigateTo('/');
                });
                
                this.getChild('.back-btn').addEventListener('click', () => navigateTo('/lists'));
                this.getChild('.delete-list-btn').addEventListener('click', () => this.deleteListModal.open());
                
                const titleInput = this.getChild('.list-title-input');
                titleInput.addEventListener('blur', () => this.updateListName());
                titleInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        titleInput.blur();
                    }
                });
                
                // Handle add todo form
                addTodoForm.addEventListener('n-submit-success', () => {
                    this.loadTodos();
                });
                
                // Handle checkbox toggle
                this.todosEl.addEventListener('change', (e) => {
                    if (e.target.classList.contains('todo-checkbox')) {
                        this.toggleTodo(e.target.dataset.id);
                    }
                });
                
                // Handle delete button
                this.todosEl.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-todo-btn')) {
                        e.stopPropagation();
                        this.deleteTodoId = e.target.dataset.id;
                        this.deleteTodoModal.open();
                    }
                });
                
                // Handle delete list modal - uses api service
                this.deleteListModal.addEventListener('n-modal-confirm', async () => {
                    await this.api.deleteList(this.listId);
                    this.deleteListModal.close();
                    navigateTo('/lists');
                });
                
                // Handle delete todo modal - uses api service
                this.deleteTodoModal.addEventListener('n-modal-confirm', async () => {
                    if (this.deleteTodoId) {
                        await this.api.deleteTodo(this.deleteTodoId);
                        this.deleteTodoModal.close();
                        this.deleteTodoId = null;
                        this.loadTodos();
                    }
                });
                
                this.loadTodos();
            }
            
            async loadTodos() {
                try {
                    const data = await this.api.getTodos(this.listId);
                    
                    this.getChild('.list-title-input').value = data.list.name;
                    this.todosEl.setItems(data.todos || []);
                    
                    // Set checkbox states after render
                    this.todosEl.querySelectorAll('.todo-item').forEach(item => {
                        const isCompleted = item.dataset.completed === '1';
                        const checkbox = item.querySelector('.todo-checkbox');
                        const text = item.querySelector('.todo-text');
                        if (checkbox) checkbox.checked = isCompleted;
                        if (text && isCompleted) text.classList.add('completed');
                    });
                } catch {
                    navigateTo('/lists');
                }
            }
            
            async toggleTodo(id) {
                await this.api.toggleTodo(id);
                this.loadTodos();
            }
            
            async updateListName() {
                const name = this.getChild('.list-title-input').value.trim();
                if (name) {
                    await this.api.updateList(this.listId, { name });
                }
            }
        }
        
        // ============================================
        // INITIALIZE APP WITH DI
        // ============================================
        const app = createNativeJs(
            document.getElementById('app'),
            [
                { pathname: '/', element: AuthPage },
                { pathname: '/lists', element: ListsPage },
                { pathname: '/list/:id', element: TodosPage }
            ],
            { basePath: '' }
        );
        
        // Register services - order matters (auth first since api depends on it)
        app.singleton('auth', AuthService);
        app.singleton('api', ApiService);
        
        // Start the app
        app.run();
        
        // Initial auth check
        app.resolve('auth').checkAuth();
    </script>
</body>
</html>
