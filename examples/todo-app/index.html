<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App | Native.js</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        #app {
            max-width: 600px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        /* Auth Forms */
        .auth-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .auth-container h1 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #667eea;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #eee;
        }
        
        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            color: #666;
            transition: all 0.2s;
        }
        
        .auth-tab.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            margin-bottom: -2px;
        }
        
        .auth-form {
            display: none;
            flex-direction: column;
            gap: 1rem;
        }
        
        .auth-form.active { display: flex; }
        
        input {
            padding: 0.875rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover { background: #e0e0e0; }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover { background: #c82333; }
        
        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        /* n-submit-form messages */
        .n-form-message {
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .n-form-error {
            background: #f8d7da;
            color: #721c24;
        }
        .n-form-success {
            background: #d4edda;
            color: #155724;
        }
        
        /* App Layout */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .app-header h1 {
            color: white;
            font-size: 1.5rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: white;
        }
        
        /* Lists */
        .lists-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .section-header h2 {
            color: #333;
        }
        
        .new-list-form,
        n-submit-form[n-action="/api/lists"] form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .new-list-form input,
        n-submit-form[n-action="/api/lists"] input { flex: 1; }
        
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .list-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .list-item-name {
            font-weight: 500;
        }
        
        .list-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* n-list empty state */
        .n-list-empty {
            text-align: center;
            padding: 2rem;
            color: #999;
        }
        
        /* Todos */
        .list-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .back-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
        }
        
        .list-title {
            flex: 1;
        }
        
        .list-title-input {
            font-size: 1.25rem;
            font-weight: 600;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 0.25rem 0;
            width: 100%;
        }
        
        .list-title-input:focus {
            outline: none;
            border-bottom-color: #667eea;
        }
        
        .new-todo-form,
        n-submit-form.new-todo-form form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .new-todo-form input,
        n-submit-form.new-todo-form input { flex: 1; }
        
        .todo-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .todo-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        .todo-text {
            flex: 1;
        }
        
        .todo-text.completed {
            text-decoration: line-through;
            color: #999;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        /* Native.js Modal customization */
        n-modal {
            --n-modal-bg: white;
            --n-modal-radius: 12px;
            --n-modal-max-width: 400px;
            --n-modal-padding: 1.5rem;
            --n-modal-border: #eee;
        }
        
        n-modal .n-modal-title {
            color: #333;
        }
        
        n-modal .n-modal-footer button {
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <main id="app"></main>

    <!-- Auth Page Template -->
    <template id="tpl-auth">
        <div class="auth-container">
            <h1>üìù Todo App</h1>
            
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">Login</button>
                <button class="auth-tab" data-tab="register">Register</button>
            </div>
            
            <div class="error-message" style="display: none;"></div>
            
            <!-- Login Form using n-submit-form -->
            <n-submit-form 
                class="auth-form active" 
                id="login-form"
                n-action="/api/login"
                n-reset="false">
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn-primary">Login</button>
            </n-submit-form>
            
            <!-- Register Form using n-submit-form -->
            <n-submit-form 
                class="auth-form" 
                id="register-form"
                n-action="/api/register"
                n-reset="false">
                <input type="text" name="username" placeholder="Username" required minlength="3">
                <input type="password" name="password" placeholder="Password (min 4 chars)" required minlength="4">
                <input type="password" name="password_confirm" placeholder="Confirm Password" required>
                <button type="submit" class="btn-primary">Create Account</button>
            </n-submit-form>
        </div>
    </template>

    <!-- Lists Page Template -->
    <template id="tpl-lists">
        <div class="app-header">
            <h1>üìù My Lists</h1>
            <div class="user-info">
                <span class="username"></span>
                <button class="btn-secondary btn-small logout-btn">Logout</button>
            </div>
        </div>
        
        <div class="lists-container">
            <!-- Create List Form using n-submit-form -->
            <n-submit-form 
                n-action="/api/lists" 
                class="new-list-form"
                n-success-message="">
                <input type="text" name="name" placeholder="New list name..." required>
                <button type="submit" class="btn-primary">Add List</button>
            </n-submit-form>
            
            <!-- Lists using n-list component -->
            <n-list id="lists-list" n-empty-text="No lists yet. Create one above!">
                <template n-item>
                    <div class="list-item" data-id="{{id}}">
                        <span class="list-item-name">{{name}}</span>
                        <div class="list-item-actions">
                            <button class="btn-danger btn-small delete-btn" data-id="{{id}}">üóëÔ∏è</button>
                        </div>
                    </div>
                </template>
            </n-list>
        </div>
    </template>

    <!-- Todos Page Template -->
    <template id="tpl-todos">
        <div class="app-header">
            <h1>üìù Todo App</h1>
            <div class="user-info">
                <span class="username"></span>
                <button class="btn-secondary btn-small logout-btn">Logout</button>
            </div>
        </div>
        
        <div class="lists-container">
            <div class="list-header">
                <button class="back-btn">‚Üê</button>
                <div class="list-title">
                    <input type="text" class="list-title-input" placeholder="List name">
                </div>
                <button class="btn-danger btn-small delete-list-btn">Delete List</button>
            </div>
            
            <!-- Create Todo Form using n-submit-form -->
            <n-submit-form 
                class="new-todo-form"
                n-action=""
                n-success-message="">
                <input type="text" name="text" placeholder="Add a new todo..." required>
                <button type="submit" class="btn-primary">Add</button>
            </n-submit-form>
            
            <!-- Todos using n-list component -->
            <n-list id="todos-list" n-empty-text="No todos yet. Add one above!">
                <template n-item>
                    <div class="todo-item" data-id="{{id}}">
                        <input type="checkbox" class="todo-checkbox" data-id="{{id}}">
                        <span class="todo-text">{{text}}</span>
                        <button class="btn-secondary btn-small delete-todo-btn" data-id="{{id}}">üóëÔ∏è</button>
                    </div>
                </template>
            </n-list>
        </div>
        
        <!-- Delete Confirmation Modal using n-modal -->
        <n-modal id="delete-modal" n-title="Delete List?" n-closable="true">
            <p>This will permanently delete the list and all its todos.</p>
            <div n-slot="footer">
                <button class="btn-secondary" n-modal-cancel>Cancel</button>
                <button class="btn-danger" n-modal-confirm>Delete</button>
            </div>
        </n-modal>
    </template>

    <script type="module">
        import { 
            createNativeJs, 
            NativeJsComponent, 
            createNativeJsComponentRegistry,
            createNativeJsDataService,
            registerDefaultComponents,
            NativeJsModal,
            NativeJsList
        } from "../lib/index.js";
        
        const container = document.querySelector('#app');
        
        // Standalone data service for auth check (before component is mounted)
        const authService = createNativeJsDataService();
        
        // Check if user is logged in
        async function checkAuth() {
            const result = await authService.fetch('/api/me');
            return result.ok ? result.data?.user : null;
        }
        
        // ==================== AUTH COMPONENT ====================
        class AuthPage extends NativeJsComponent {
            static tagName = 'n-auth-page';
            static templateId = 'tpl-auth';
            
            onInit() {
                this.setupTabs();
                this.setupForms();
            }
            
            setupTabs() {
                const tabs = this.getChildren('.auth-tab');
                const loginForm = this.getChild('#login-form');
                const registerForm = this.getChild('#register-form');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        if (tab.dataset.tab === 'login') {
                            loginForm.classList.add('active');
                            registerForm.classList.remove('active');
                        } else {
                            loginForm.classList.remove('active');
                            registerForm.classList.add('active');
                        }
                        
                        this.hideError();
                    });
                });
            }
            
            setupForms() {
                const loginForm = this.getChild('#login-form');
                const registerForm = this.getChild('#register-form');
                
                // Handle login form success/error via n-submit-form events
                loginForm.addEventListener('n-submit-success', () => {
                    window.location.href = '/lists';
                });
                
                loginForm.addEventListener('n-submit-error', (e) => {
                    this.showError(e.detail.error || 'Login failed');
                });
                
                // Handle register form - need to validate password match first
                registerForm.addEventListener('n-submit-start', (e) => {
                    const data = e.detail.data;
                    if (data.password !== data.password_confirm) {
                        e.preventDefault();
                        this.showError('Passwords do not match');
                    }
                });
                
                registerForm.addEventListener('n-submit-success', () => {
                    window.location.href = '/lists';
                });
                
                registerForm.addEventListener('n-submit-error', (e) => {
                    this.showError(e.detail.error || 'Registration failed');
                });
            }
            
            showError(message) {
                const errorEl = this.getChild('.error-message');
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            }
            
            hideError() {
                const errorEl = this.getChild('.error-message');
                errorEl.style.display = 'none';
            }
        }
        
        // ==================== LISTS COMPONENT ====================
        class ListsPage extends NativeJsComponent {
            static tagName = 'n-lists-page';
            static templateId = 'tpl-lists';
            
            /** @type {NativeJsList} */
            listComponent = null;
            
            async onInit() {
                const user = await checkAuth();
                if (!user) {
                    window.location.href = '/';
                    return;
                }
                
                this.getChild('.username').textContent = user.username;
                this.getChild('.logout-btn').addEventListener('click', () => this.logout());
                
                // Get the n-list component
                this.listComponent = this.getChild('#lists-list');
                
                // Setup form submission handler
                const createForm = this.getChild('n-submit-form');
                createForm.addEventListener('n-submit-success', () => {
                    this.loadLists();
                });
                
                // Setup list click handlers
                this.listComponent.addEventListener('n-item-click', (e) => {
                    const { item, originalEvent } = e.detail;
                    // Don't navigate if clicking delete button
                    if (!originalEvent.target.classList.contains('delete-btn')) {
                        window.location.href = `/list/${item.id}`;
                    }
                });
                
                // Setup delete buttons via event delegation
                this.listComponent.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-btn')) {
                        e.stopPropagation();
                        this.deleteList(e.target.dataset.id);
                    }
                });
                
                this.loadLists();
            }
            
            async logout() {
                await this.data.post('/api/logout', {});
                window.location.href = '/';
            }
            
            async loadLists() {
                const result = await this.data.fetch('/api/lists', { stateKey: 'lists' });
                
                if (result.ok && result.data?.lists) {
                    this.listComponent.setItems(result.data.lists);
                } else {
                    this.listComponent.setItems([]);
                }
            }
            
            async deleteList(id) {
                if (confirm('Delete this list and all its todos?')) {
                    await this.data.delete(`/api/lists/${id}`);
                    this.loadLists();
                }
            }
        }
        
        // ==================== TODOS COMPONENT ====================
        class TodosPage extends NativeJsComponent {
            static tagName = 'n-todos-page';
            static templateId = 'tpl-todos';
            
            listId = null;
            /** @type {NativeJsList} */
            todosComponent = null;
            /** @type {NativeJsModal} */
            deleteModal = null;
            
            async onInit(urlPatternResult) {
                const user = await checkAuth();
                if (!user) {
                    window.location.href = '/';
                    return;
                }
                
                this.listId = urlPatternResult?.pathname?.groups?.id;
                if (!this.listId) {
                    window.location.href = '/lists';
                    return;
                }
                
                this.getChild('.username').textContent = user.username;
                this.getChild('.logout-btn').addEventListener('click', () => this.logout());
                this.getChild('.back-btn').addEventListener('click', () => window.location.href = '/lists');
                this.getChild('.delete-list-btn').addEventListener('click', () => this.deleteModal.open());
                
                // List name editing
                const titleInput = this.getChild('.list-title-input');
                titleInput.addEventListener('blur', () => this.updateListName());
                titleInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        titleInput.blur();
                    }
                });
                
                // Get the n-list component for todos
                this.todosComponent = this.getChild('#todos-list');
                
                // Get and setup the modal
                this.deleteModal = this.getChild('#delete-modal');
                this.deleteModal.addEventListener('n-modal-confirm', () => this.deleteList());
                
                // Setup the create todo form - set dynamic action URL
                const createForm = this.getChild('n-submit-form');
                createForm.setAttribute('n-action', `/api/lists/${this.listId}/todos`);
                createForm.addEventListener('n-submit-success', () => {
                    this.loadTodos();
                });
                
                // Setup todo item interactions via event delegation
                this.todosComponent.addEventListener('click', (e) => {
                    const todoItem = e.target.closest('.todo-item');
                    if (!todoItem) return;
                    
                    const todoId = todoItem.dataset.id;
                    
                    if (e.target.classList.contains('todo-checkbox')) {
                        this.toggleTodo(todoId);
                    } else if (e.target.classList.contains('delete-todo-btn')) {
                        this.deleteTodo(todoId);
                    }
                });
                
                this.loadTodos();
            }
            
            async logout() {
                await this.data.post('/api/logout', {});
                window.location.href = '/';
            }
            
            async loadTodos() {
                const result = await this.data.fetch(`/api/lists/${this.listId}/todos`, { stateKey: 'todos' });
                
                if (!result.ok) {
                    window.location.href = '/lists';
                    return;
                }
                
                // Set list name
                this.getChild('.list-title-input').value = result.data.list.name;
                
                // Map todos to include completed class info
                const todos = (result.data?.todos || []).map(todo => ({
                    ...todo,
                    completedClass: todo.completed ? 'completed' : ''
                }));
                
                this.todosComponent.setItems(todos);
                
                // Update checkbox states and text styling after render
                setTimeout(() => {
                    this.getChildren('.todo-item').forEach(item => {
                        const todoId = item.dataset.id;
                        const todo = todos.find(t => String(t.id) === todoId);
                        if (todo) {
                            const checkbox = item.querySelector('.todo-checkbox');
                            const textSpan = item.querySelector('.todo-text');
                            if (checkbox) checkbox.checked = todo.completed;
                            if (textSpan && todo.completed) textSpan.classList.add('completed');
                        }
                    });
                }, 0);
            }
            
            async toggleTodo(todoId) {
                await this.data.put(`/api/todos/${todoId}`, { toggle: true });
                this.loadTodos();
            }
            
            async deleteTodo(todoId) {
                await this.data.delete(`/api/todos/${todoId}`);
                this.loadTodos();
            }
            
            async updateListName() {
                const name = this.getChild('.list-title-input').value.trim();
                if (!name) return;
                await this.data.put(`/api/lists/${this.listId}`, { name });
            }
            
            async deleteList() {
                await this.data.delete(`/api/lists/${this.listId}`);
                window.location.href = '/lists';
            }
        }
        
        // ==================== REGISTER & RUN ====================
        const registry = createNativeJsComponentRegistry();
        
        // Register default Native.js components (n-submit-form, n-modal, n-list, etc.)
        registerDefaultComponents(registry);
        
        const routes = [
            { pathname: '/', element: AuthPage },
            { pathname: '/lists', element: ListsPage },
            { pathname: '/list/:id', element: TodosPage }
        ];
        
        const nativeJs = createNativeJs(container, routes);
        nativeJs.run();
        
        window.nativeJs = nativeJs;
    </script>
</body>
</html>
