<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #222;
            line-height: 1.5;
        }
        
        #app {
            max-width: 480px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        /* Forms */
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            background: white;
        }
        
        input:focus {
            outline: none;
            border-color: #333;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .btn {
            background: #222;
            color: white;
        }
        
        .btn:hover { background: #444; }
        .btn:disabled { background: #999; cursor: not-allowed; }
        
        .btn-ghost {
            background: transparent;
            color: #666;
            border: 1px solid #ddd;
        }
        
        .btn-ghost:hover { background: #f0f0f0; }
        
        .btn-delete {
            background: transparent;
            color: #999;
            padding: 8px;
        }
        
        .btn-delete:hover { color: #c00; }
        
        /* Card */
        .card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .card-body {
            padding: 24px;
        }
        
        /* Auth */
        .auth-title {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 24px;
        }
        
        .auth-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 24px;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: none;
            border: none;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        
        .auth-tab.active {
            color: #222;
            border-bottom-color: #222;
        }
        
        .auth-form {
            display: none;
            flex-direction: column;
            gap: 16px;
        }
        
        .auth-form.active { display: flex; }
        
        .error-msg {
            background: #fee;
            color: #c00;
            padding: 12px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #666;
        }
        
        /* Add form */
        .add-form {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .add-form input { flex: 1; }
        
        /* List items */
        .list-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: #fafafa; }
        
        .list-item-name {
            flex: 1;
            font-size: 15px;
        }
        
        /* Todo items */
        .todo-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            gap: 12px;
        }
        
        .todo-item:last-child { border-bottom: none; }
        
        .todo-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .todo-text {
            flex: 1;
            font-size: 15px;
        }
        
        .todo-text.completed {
            text-decoration: line-through;
            color: #999;
        }
        
        /* List header */
        .list-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .back-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            color: #666;
        }
        
        .back-btn:hover { color: #222; }
        
        .list-title-input {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            border: none;
            padding: 4px 0;
            background: transparent;
        }
        
        .list-title-input:focus {
            outline: none;
            border-bottom: 1px solid #ddd;
        }
        
        /* Empty state */
        .empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 14px;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .modal {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 360px;
            width: 90%;
        }
        
        .modal h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .modal p {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .modal-actions .btn-danger {
            background: #c00;
            color: white;
        }
        
        .modal-actions .btn-danger:hover { background: #a00; }
    </style>
</head>
<body>
    <main id="app"></main>

    <!-- Auth Page -->
    <template id="tpl-auth">
        <div class="card">
            <div class="card-body">
                <h1 class="auth-title">Todo</h1>
                
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">Sign in</button>
                    <button class="auth-tab" data-tab="register">Create account</button>
                </div>
                
                <div class="error-msg" style="display: none;"></div>
                
                <form class="auth-form active" id="login-form">
                    <input type="text" name="username" placeholder="Username" required>
                    <input type="password" name="password" placeholder="Password" required>
                    <button type="submit" class="btn">Sign in</button>
                </form>
                
                <form class="auth-form" id="register-form">
                    <input type="text" name="username" placeholder="Username" required minlength="3">
                    <input type="password" name="password" placeholder="Password" required minlength="4">
                    <input type="password" name="password_confirm" placeholder="Confirm password" required>
                    <button type="submit" class="btn">Create account</button>
                </form>
            </div>
        </div>
    </template>

    <!-- Lists Page -->
    <template id="tpl-lists">
        <div class="header">
            <h1>My Lists</h1>
            <div class="header-right">
                <span class="username"></span>
                <button class="btn-ghost logout-btn">Sign out</button>
            </div>
        </div>
        
        <form class="add-form" id="add-list-form">
            <input type="text" name="name" placeholder="New list..." required>
            <button type="submit" class="btn">Add</button>
        </form>
        
        <div class="card">
            <div class="lists-content"></div>
        </div>
        
        <div class="modal-overlay" style="display: none;">
            <div class="modal">
                <h3>Delete this list?</h3>
                <p>All todos in this list will be deleted.</p>
                <div class="modal-actions">
                    <button class="btn-ghost cancel-btn">Cancel</button>
                    <button class="btn-danger confirm-btn">Delete</button>
                </div>
            </div>
        </div>
    </template>

    <!-- Todos Page -->
    <template id="tpl-todos">
        <div class="header">
            <h1>Todo</h1>
            <div class="header-right">
                <span class="username"></span>
                <button class="btn-ghost logout-btn">Sign out</button>
            </div>
        </div>
        
        <div class="list-header">
            <button class="back-btn">←</button>
            <input type="text" class="list-title-input" placeholder="List name">
            <button class="btn-delete delete-list-btn">Delete</button>
        </div>
        
        <form class="add-form" id="add-todo-form">
            <input type="text" name="text" placeholder="Add todo..." required>
            <button type="submit" class="btn">Add</button>
        </form>
        
        <div class="card">
            <div class="todos-content"></div>
        </div>
        
        <div class="modal-overlay" style="display: none;">
            <div class="modal">
                <h3>Delete this list?</h3>
                <p>All todos in this list will be deleted.</p>
                <div class="modal-actions">
                    <button class="btn-ghost cancel-btn">Cancel</button>
                    <button class="btn-danger confirm-btn">Delete</button>
                </div>
            </div>
        </div>
    </template>

    <script type="module">
        import { 
            createNativeJs, 
            NativeJsComponent, 
            createNativeJsComponentRegistry,
            createNativeJsDataService
        } from "../lib/index.js";
        
        const container = document.querySelector('#app');
        const authService = createNativeJsDataService();
        
        async function checkAuth() {
            const result = await authService.fetch('/api/me');
            return result.ok ? result.data?.user : null;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==================== AUTH ====================
        class AuthPage extends NativeJsComponent {
            static tagName = 'n-auth-page';
            static templateId = 'tpl-auth';
            
            onInit() {
                const tabs = this.getChildren('.auth-tab');
                const loginForm = this.getChild('#login-form');
                const registerForm = this.getChild('#register-form');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        loginForm.classList.toggle('active', tab.dataset.tab === 'login');
                        registerForm.classList.toggle('active', tab.dataset.tab === 'register');
                        this.hideError();
                    });
                });
                
                loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                registerForm.addEventListener('submit', (e) => this.handleRegister(e));
            }
            
            showError(msg) {
                const el = this.getChild('.error-msg');
                el.textContent = msg;
                el.style.display = 'block';
            }
            
            hideError() {
                this.getChild('.error-msg').style.display = 'none';
            }
            
            async handleLogin(e) {
                e.preventDefault();
                const form = e.target;
                const result = await this.data.post('/api/login', {
                    username: form.username.value,
                    password: form.password.value
                });
                
                if (result.ok) {
                    window.location.href = '/lists';
                } else {
                    this.showError(result.error || 'Login failed');
                }
            }
            
            async handleRegister(e) {
                e.preventDefault();
                const form = e.target;
                
                if (form.password.value !== form.password_confirm.value) {
                    this.showError('Passwords do not match');
                    return;
                }
                
                const result = await this.data.post('/api/register', {
                    username: form.username.value,
                    password: form.password.value
                });
                
                if (result.ok) {
                    window.location.href = '/lists';
                } else {
                    this.showError(result.error || 'Registration failed');
                }
            }
        }
        
        // ==================== LISTS ====================
        class ListsPage extends NativeJsComponent {
            static tagName = 'n-lists-page';
            static templateId = 'tpl-lists';
            
            deleteListId = null;
            
            async onInit() {
                const user = await checkAuth();
                if (!user) {
                    window.location.href = '/';
                    return;
                }
                
                this.getChild('.username').textContent = user.username;
                this.getChild('.logout-btn').addEventListener('click', () => this.logout());
                this.getChild('#add-list-form').addEventListener('submit', (e) => this.addList(e));
                this.getChild('.cancel-btn').addEventListener('click', () => this.hideModal());
                this.getChild('.confirm-btn').addEventListener('click', () => this.confirmDelete());
                
                this.loadLists();
            }
            
            async logout() {
                await this.data.post('/api/logout', {});
                window.location.href = '/';
            }
            
            showModal(listId) {
                this.deleteListId = listId;
                this.getChild('.modal-overlay').style.display = 'flex';
            }
            
            hideModal() {
                this.deleteListId = null;
                this.getChild('.modal-overlay').style.display = 'none';
            }
            
            async confirmDelete() {
                if (this.deleteListId) {
                    await this.data.delete(`/api/lists/${this.deleteListId}`);
                    this.hideModal();
                    this.loadLists();
                }
            }
            
            async loadLists() {
                const content = this.getChild('.lists-content');
                const result = await this.data.fetch('/api/lists');
                
                if (!result.ok || !result.data?.lists?.length) {
                    content.innerHTML = '<div class="empty">No lists yet</div>';
                    return;
                }
                
                content.innerHTML = result.data.lists.map(list => `
                    <div class="list-item" data-id="${list.id}">
                        <span class="list-item-name">${escapeHtml(list.name)}</span>
                        <button class="btn-delete delete-btn" data-id="${list.id}">×</button>
                    </div>
                `).join('');
                
                this.getChildren('.list-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('delete-btn')) {
                            window.location.href = `/list/${item.dataset.id}`;
                        }
                    });
                });
                
                this.getChildren('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.showModal(btn.dataset.id);
                    });
                });
            }
            
            async addList(e) {
                e.preventDefault();
                const input = e.target.name;
                if (!input.value.trim()) return;
                
                await this.data.post('/api/lists', { name: input.value.trim() });
                input.value = '';
                this.loadLists();
            }
        }
        
        // ==================== TODOS ====================
        class TodosPage extends NativeJsComponent {
            static tagName = 'n-todos-page';
            static templateId = 'tpl-todos';
            
            listId = null;
            
            async onInit(urlPatternResult) {
                const user = await checkAuth();
                if (!user) {
                    window.location.href = '/';
                    return;
                }
                
                this.listId = urlPatternResult?.pathname?.groups?.id;
                if (!this.listId) {
                    window.location.href = '/lists';
                    return;
                }
                
                this.getChild('.username').textContent = user.username;
                this.getChild('.logout-btn').addEventListener('click', () => this.logout());
                this.getChild('.back-btn').addEventListener('click', () => window.location.href = '/lists');
                this.getChild('.delete-list-btn').addEventListener('click', () => this.showModal());
                this.getChild('#add-todo-form').addEventListener('submit', (e) => this.addTodo(e));
                
                const titleInput = this.getChild('.list-title-input');
                titleInput.addEventListener('blur', () => this.updateListName());
                titleInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        titleInput.blur();
                    }
                });
                
                this.getChild('.cancel-btn').addEventListener('click', () => this.hideModal());
                this.getChild('.confirm-btn').addEventListener('click', () => this.deleteList());
                
                this.loadTodos();
            }
            
            async logout() {
                await this.data.post('/api/logout', {});
                window.location.href = '/';
            }
            
            showModal() {
                this.getChild('.modal-overlay').style.display = 'flex';
            }
            
            hideModal() {
                this.getChild('.modal-overlay').style.display = 'none';
            }
            
            async loadTodos() {
                const content = this.getChild('.todos-content');
                const result = await this.data.fetch(`/api/lists/${this.listId}/todos`);
                
                if (!result.ok) {
                    window.location.href = '/lists';
                    return;
                }
                
                this.getChild('.list-title-input').value = result.data.list.name;
                
                if (!result.data.todos?.length) {
                    content.innerHTML = '<div class="empty">No todos yet</div>';
                    return;
                }
                
                content.innerHTML = result.data.todos.map(todo => `
                    <div class="todo-item" data-id="${todo.id}">
                        <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''}>
                        <span class="todo-text ${todo.completed ? 'completed' : ''}">${escapeHtml(todo.text)}</span>
                        <button class="btn-delete delete-todo-btn">×</button>
                    </div>
                `).join('');
                
                this.getChildren('.todo-checkbox').forEach(cb => {
                    cb.addEventListener('change', () => {
                        const id = cb.closest('.todo-item').dataset.id;
                        this.toggleTodo(id);
                    });
                });
                
                this.getChildren('.delete-todo-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.closest('.todo-item').dataset.id;
                        this.deleteTodo(id);
                    });
                });
            }
            
            async addTodo(e) {
                e.preventDefault();
                const input = e.target.text;
                if (!input.value.trim()) return;
                
                await this.data.post(`/api/lists/${this.listId}/todos`, { text: input.value.trim() });
                input.value = '';
                this.loadTodos();
            }
            
            async toggleTodo(id) {
                await this.data.put(`/api/todos/${id}`, { toggle: true });
                this.loadTodos();
            }
            
            async deleteTodo(id) {
                await this.data.delete(`/api/todos/${id}`);
                this.loadTodos();
            }
            
            async updateListName() {
                const name = this.getChild('.list-title-input').value.trim();
                if (name) {
                    await this.data.put(`/api/lists/${this.listId}`, { name });
                }
            }
            
            async deleteList() {
                await this.data.delete(`/api/lists/${this.listId}`);
                window.location.href = '/lists';
            }
        }
        
        // ==================== INIT ====================
        const registry = createNativeJsComponentRegistry();
        
        const routes = [
            { pathname: '/', element: AuthPage },
            { pathname: '/lists', element: ListsPage },
            { pathname: '/list/:id', element: TodosPage }
        ];
        
        // basePath: '' because this app runs at the root of its own server
        const nativeJs = createNativeJs(container, routes, { basePath: '' });
        nativeJs.run();
    </script>
</body>
</html>
