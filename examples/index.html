<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello World | Native.js</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 2rem; }
        .counter { display: flex; gap: 1rem; align-items: center; margin: 1rem 0; }
        button { padding: 0.5rem 1rem; cursor: pointer; }
        .state-display { background: #f0f0f0; padding: 1rem; border-radius: 4px; margin: 1rem 0; }
    </style>
</head>
<body>
    <main id="app"></main>

    <template id="tpl-home">
        <h1 id="main-h1">Main Page</h1>
        
        <!-- Counter using n-state attribute (inline state) -->
        <section>
            <h3>Counter with Attribute State (n-state)</h3>
            <n-counter n-state='{"count": 0}'></n-counter>
        </section>

        <!-- Counter using n-state-key (sessionStorage backed) -->
        <section>
            <h3>Counter with Session Storage (n-state-key)</h3>
            <p><em>This counter persists across page refreshes within the session</em></p>
            <n-counter n-state-key="session-counter" n-state-storage="session"></n-counter>
        </section>

        <!-- Counter using n-state-key (localStorage backed) -->
        <section>
            <h3>Counter with Local Storage (n-state-key)</h3>
            <p><em>This counter persists even after browser restart</em></p>
            <n-counter n-state-key="local-counter" n-state-storage="local"></n-counter>
        </section>

        <hr>
        <a n-href="/hello-world">Go to Hello World</a>
        <n-footer></n-footer>
    </template>

    <template id="tpl-counter">
        <div class="counter">
            <button class="decrement">-</button>
            <span class="count">0</span>
            <button class="increment">+</button>
        </div>
        <div class="state-display">
            <strong>State mode:</strong> <span class="mode"></span><br>
            <strong>Current state:</strong> <code class="state-json"></code>
        </div>
    </template>

    <template id="tpl-hello-world">
        <h2>Hello World Page</h2>
        <a n-href="/">Back to Home</a>
        <a n-href="/other-page">Go to Other Page</a>
        <n-footer></n-footer>
    </template>

    <template id="tpl-other-page">
        <h2>Other Page</h2>
        <a n-href="/">Back to Home</a>
        <n-footer></n-footer>
    </template>

    <template id="tpl-footer">
        <footer style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ccc;">
            <p>Native.js Footer Component</p>
        </footer>
    </template>
    
    <!-- Custom Implementation -->
    <script type="module">
        import { createNativeJs, NativeJsComponent, createNativeJsComponentRegistry } from "/lib/index.js";
        
        const container = document.querySelector('#app');

        // Counter component - demonstrates state usage
        class CounterElement extends NativeJsComponent {
            static tagName = 'n-counter';
            static templateId = 'tpl-counter';

            onInit() {
                // Initialize count if not set
                if (!this.state.has('count')) {
                    this.state.set('count', 0);
                }

                this.updateDisplay();
                this.setupEventListeners();
            }

            setupEventListeners() {
                const incrementBtn = this.getChild('.increment');
                const decrementBtn = this.getChild('.decrement');

                incrementBtn?.addEventListener('click', () => {
                    const count = this.state.get('count') ?? 0;
                    this.state.set('count', count + 1);
                    this.updateDisplay();
                });

                decrementBtn?.addEventListener('click', () => {
                    const count = this.state.get('count') ?? 0;
                    this.state.set('count', count - 1);
                    this.updateDisplay();
                });
            }

            updateDisplay() {
                const countEl = this.getChild('.count');
                const modeEl = this.getChild('.mode');
                const stateJsonEl = this.getChild('.state-json');

                if (countEl) {
                    countEl.textContent = String(this.state.get('count') ?? 0);
                }
                if (modeEl) {
                    const mode = this.state.getMode();
                    const storageKey = this.state.getStorageKey();
                    modeEl.textContent = mode === 'storage' ? `storage (${storageKey})` : 'attribute';
                }
                if (stateJsonEl) {
                    stateJsonEl.textContent = JSON.stringify(this.state.getAll());
                }
            }
        }

        // Footer component
        class FooterElement extends NativeJsComponent {
            static tagName = 'n-footer';
            static templateId = 'tpl-footer';
        }

        // Main page component
        class MainElement extends NativeJsComponent {
            static tagName = 'n-main';
            static templateId = 'tpl-home';

            onInit() {
                console.log('MainElement initialized');
                const h1 = this.getChild('#main-h1');
                if (h1) {
                    h1.innerText = 'Main Page - State Demo';
                }
            }
        }

        // Hello World component
        class HelloWorldElement extends NativeJsComponent {
            static tagName = 'n-hello-world';
            static templateId = 'tpl-hello-world';
        }

        // Other Page component
        class OtherPageElement extends NativeJsComponent {
            static tagName = 'n-other-page';
            static templateId = 'tpl-other-page';
        }

        // Register non-routed components manually
        const registry = createNativeJsComponentRegistry();
        registry.registerComponentClass(FooterElement);
        registry.registerComponentClass(CounterElement);

        // Define routes
        const routes = [
            { pathname: '/', element: MainElement },
            { pathname: '/hello-world', element: HelloWorldElement },
            { pathname: '/other-page', element: OtherPageElement }
        ];

        // Create and run the app
        const nativeJs = createNativeJs(container, routes);
        nativeJs.run();

        // Expose for debugging
        window.nativeJs = nativeJs;
    </script>
</body>
</html>
